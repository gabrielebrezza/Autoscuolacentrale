<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota Guide</title>
    <link rel="stylesheet" href="/styles/guideBooking.css">
    <!-- icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- calendario -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
</head>
<body>
    <header class="header">
        <!-- <img src="https://autoscuolacentrale.com/templates/autoscuola/images/logo_autoscuola.svg" alt="" width="500px"> -->
        <h2>Benvenuto <%= nome %></h2>
        
    </header>
    <aside>
            <!-- <label for="data"> -->
                <div class="esami">
                    <nav>Prenotazione esami di guida</nav>
                    <% const esame = esami.exams; %>
                    <% for( let i = 0; i < esame.length; i++ ) { %>
                        <% if (i<3) { %>
                            <div class="esame">
                                <p><%= i+1 %>° Esame: 
                                    <% if (esame[i].paid == true) { %>
                                        <strong class="pagato">PAGATO</strong>  
                                    <% } else { %> 
                                        <strong data-esame="<%= i %>" class="daPagare">DA PAGARE</strong>  
                                    <% } %>
                                </p>
                            </div>
                        <% } %>
                    <% } %>

                </div>
                <span  class="material-symbols-outlined" id="data" name="data" readonly></span>
                <div class="bacheca">
                    <nav>Bacheca</nav>
                    <div class="bachecaText">
                        <p><%= bachecaContent.content %></p>
                    </div>
                </div>
                

                </span>
            <!-- </label> -->
            <!-- <input  type="hidden" id="data" name="data" readonly> -->
    </aside>

    <div class="container">
        <% for(var i = 0; i < lezioni.length; i++) { %>
            <% let exclude = false %>
            <% for( let j = 0; j < excludeInstructor.length; j++ ) { %>
                <% if (excludeInstructor[j].instructor == lezioni[i].instructor) { %>
                    <% exclude = true; %>
                <% } %>
            <% } %>
            <% if (exclude) { %>
                <% continue; %>
            <% } %>
        <% let dateElaborate = []; %>
        <% let hasAvailableTime = false; %>
        <% for(j = 0; j < lezioni[i].book.length; j++) { %>
        <% if (!dateElaborate.includes(lezioni[i].book[j].day)) { %>
        <% dateElaborate.push(lezioni[i].book[j].day); %>
        
        <% let hasStudentBooking = false; %>
        <% for(k = 0; k < lezioni[i].book[j].schedule.length; k++) { %>
            <% const schedule = lezioni[i].book[j].schedule[k]; %>
            <% if(!schedule.student) { %>
                <% hasAvailableTime = true; %>
            <% } else if (schedule.student == nome) { %>
                <% hasStudentBooking = true; %>
            <% } %>
        <% } %>
    
        <% if(hasAvailableTime || hasStudentBooking) { %>
        <section class="section" data-date="<%= lezioni[i].book[j].day %>">
            <h2 class="section-title"><%= lezioni[i].instructor %> - <%= lezioni[i].book[j].day %></h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Ora</th>
                    </tr>
                </thead>
                <tbody>
                    <% let lessonBookedYet = 0;%>
                    <% for(k = 0; k < lezioni[i].book[j].schedule.length; k++) { %>
                    <% const schedule = lezioni[i].book[j].schedule[k]; %>

                    
                    <% if(!schedule.student && lessonBookedYet != 2) { %>
                    <tr>
                        <td class="hour"><%= schedule.hour %></td>
                        <td>
                            <button class="book" data-time="<%= lezioni[i].book[j].day %> - <%= schedule.hour %>"
                                data-instructor="<%= lezioni[i].instructor %>"
                                data-price="<%= schedule.price %>">Prenota</button>
                        </td>
                    </tr>
                    <% } else if (schedule.student == nome) { %>
                    <tr>
                        <td class="hour"><%= schedule.hour %></td>
                        <td>
                            <button class="removeBooking" data-time="<%= lezioni[i].book[j].day %> - <%= schedule.hour %>"
                                data-instructor="<%= lezioni[i].instructor %>">Prenotato</button>
                        </td>
                    </tr>
                    <% } else if(!schedule.student && lessonBookedYet == 2){ %>
                        <tr>
                            <td class="hour"><%= schedule.hour %></td>
                            <td>
                                <button class="bookDisabled" data-time="<%= lezioni[i].book[j].day %> - <%= schedule.hour %>"
                                    data-instructor="<%= lezioni[i].instructor %>">Disattivato</button>
                            </td>
                        </tr>
                    <% } %>
                    <% if(schedule.student) { 
                        lessonBookedYet = 1;
                        continue;
                    }%>
                    <% lessonBookedYet = lessonBookedYet == 1 || lessonBookedYet== 2? 2: 0; %>
                    <% } %>
                </tbody>
            </table>
        </section>
        <% } %>
        <% } %>
        <% } %>
        <% } %>
    </div>
    
    <div id="paymentModal" class="paymentModal modal" style="display: none;">
        <form id="paymentForm" action="/create-payment" method="POST">
            <input type="hidden" id="causeInput" name="cause" value="">
            <div class="form-group">
                <label for="price" id="priceLabel">Procedi con l'acquisto della lezione. <br> Il totale è di </label>
                <input type="hidden" id="priceInput" name="price" value="">
                <input type="hidden" id="studentInput" name="student" value="<%= nome %>">
            </div>
                    <input type="hidden" id="instructorInput" name="instructor" value="">
                    <input type="hidden" id="timeInput" name="time" value="">
                    <input type="hidden" id="numEsameInput" name="numEsame" value=""> 
            <button id="payButton" type="submit" class="btn btn-primary"><i class="fa fa-paypal"></i> Paga con PayPal</button>
        </form>
    </div>
    
    <script>
$(function() {
    $("#data").datepicker({
        dateFormat: 'dd/mm/yy', // Imposta il formato della data nel datepicker
        minDate: 0, // Imposta la data minima come oggi
        beforeShowDay: function(date) {
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();

            // Formatta la data nel formato dd/mm/yy
            var dateString = (day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + year;
            
            // Verifica se esiste un elemento .section con la data corrispondente
            var sectionExists = $('.section[data-date="' + dateString + '"]').length > 0;

            // Verifica se ci sono guide disponibili per quella data
            if (sectionExists) {
                return [true, "greenDate", "Ci sono guide libere"];
            } else {
                return [true, "redDate", "Non ci sono guide libere"];
            }
        },
        onSelect: function(dateText, inst) {
            var selectedDate = this.value;
            var Available = inst;
            console.log(Available);
            var sections = document.querySelectorAll('.section');
            sections.forEach(function (section) {
                if (section.getAttribute('data-date') === selectedDate) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
            console.log("Data selezionata: " + dateText);
        }
    });
});




    </script>

    <script>
        const studente = '<%= nome %>';
        const paymentModal = document.getElementById('paymentModal');
        const instructorInput = document.getElementById('instructorInput');
        const timeInput = document.getElementById('timeInput');
        const priceInput = document.getElementById('priceInput');
        const priceLabel = document.getElementById('priceLabel');
        const causeInput = document.getElementById('causeInput');
        const numEsameInput = document.getElementById('numEsameInput');
        // Gestore per prenotare una lezione
        const bookButtons = document.querySelectorAll('.book');
        bookButtons.forEach(async(button) => {
            button.addEventListener("click", bookHandler);
        });

        async function  bookHandler(event) {
            const button = event.currentTarget;
            const instructor = button.dataset.instructor;
            const time = button.dataset.time;
            const price = button.dataset.price;
            causeInput.value = 'lesson';
            instructorInput.value = instructor;
            timeInput.value = time;
            priceLabel.append(price + '€');
            paymentModal.style.display = 'flex';
            setTimeout(() =>{
                paymentModal.style.opacity = 1;
            }, 100)
        }



        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear(); 
        today = dd + '/' + mm + '/' + yyyy;
        document.addEventListener('DOMContentLoaded', () =>{
            const section = document.querySelectorAll('.section');
                section.forEach((section) => {
                    if(section.dataset.date == today){
                        section.style.display = 'block';
                        console.log('trovato oggi');
                    }else{
                        section.style.display = 'none';
                        console.log('diverso da oggi');
                    }
                });

           
        });


        const examBtn = document.querySelector('.daPagare');
        examBtn.addEventListener('click', () =>{
            const numEsame = examBtn.dataset.esame;
            causeInput.value = 'exam'; 
            numEsameInput.value = numEsame;
            priceLabel.append(5 + '€');
            paymentModal.style.display = 'flex';
            setTimeout(() =>{
                paymentModal.style.opacity = 1;
            }, 100)
            
        });




        // // Gestore per cancellare una prenotazione
        // const removeButtons = document.querySelectorAll('.removeBooking');
        // removeButtons.forEach((button) => {
        //     button.addEventListener("click", removeBookHandler);
        // });

        // function removeBookHandler(event) {
        //     const button = event.currentTarget;
        //     removeBook(button);
        //     button.removeEventListener("click", removeBookHandler);
        // }

        // function removeBook(button) {
        //     const instructor = button.dataset.instructor;
        //     const time = button.dataset.time;
        //     fetch('/removebooking', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({ instructor: instructor, time: time, student: studente })
        //     })
        //     .then(response => {
        //         if (response.ok) {
        //             alert('Prenotazione rimossa con successo');
        //         } else {
        //             alert('Errore durante la rimozione della prenotazione');
        //         }
        //         window.location.reload();
        //     })
        //     .catch(error => {
        //         console.error('Errore durante la rimozione della prenotazione:', error);
        //     });
        // }
    </script>
</body>
</html>
