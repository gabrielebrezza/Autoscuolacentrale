<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/adminUsers.css">
    <title><%= title %></title>
    <!-- icone -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>
<body>
    <%- include('header.ejs') %>
    <div class="headerFormsContainer">
    <div class="headerForms filterSection">
        <div class="field">
            <label for="searchName">Cerca per nome:</label>
            <input type="text" id="searchName" name="searchName">
        </div>
        <div class="field">
            <label for="searchPhone">Cerca per numero di telefono:</label>
            <input type="tel" id="searchPhone" name="searchPhone">
        </div>
        <div class="field">
            <label for="searchEmail">Cerca per Email:</label>
            <input type="email" id="searchEmail" name="searchEmail">
        </div>
        <div class="field">
            <label for="searchExams">Cerca per numero di esami:</label>
            <input type="number" id="searchExams" name="searchExams" min="0">
        </div>
        <div class="field">
            <label for="searchArchived">Archiviati:</label>
            <input type="checkbox" id="searchArchived" name="searchArchived">
        </div>
        <div class="field">
            <button id="copiaEmail" name="copiaEmail">Copia Email</button>
        </div>
    </div>
        <form class="headerForms" id="createCodeForm" action="/createCode" method="POST">
            <div class="field">
            <label for="utenti">Utenti:</label>
                <select id="utenti" name="utenti" required>
                    <% for (let i = 0; i < utenti.length; i++) { %>
                        <option value="<%= utenti[i].email %>"><%= utenti[i].billingInfo[0].nome %> <%= utenti[i].billingInfo[0].cognome %></option>
                    <% } %>
                </select>
            </div>
            <div class="field">
                <label for="totaleCodici">Numero di codici:</label>
                <input type="number" name="totaleCodici" id="totaleCodici" min="1">
            </div>
            <div class="field">
                <label for="durata">Durata:</label>
                <select id="durata" name="durata" required>
                        <option value="30">30 minuti</option>
                        <option value="40">40 minuti</option>
                        <option value="60">1 ora</option>
                        <option value="120">2 ore</option>
                        <option value="esame">esame</option>
                </select>
            </div>
            <div class="field">
                <button type="button" id="createCode">Genera Codice</button>
            </div>
            <div class="field">
                <label for="code">Codice:</label>
                <input type="text" name="code" id="code" readonly required>
            </div>
            <div class="field">
                <button type="submit" >Invia</button>
            </div>
            <label style="color: #fff;" id="prezzoTotale" data-prezzo="<%= pricePerHour.prezzo %>"></label>
        </form>
    </div>
    <script>
        document.getElementById("createCode").addEventListener("click", function() {
            var totCodes = document.getElementById("totaleCodici").value;
            let codici = [];
            for(var i = 0; i < totCodes; i++){


                var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                var codeLength = 10;
                var generatedCode = '';
                for (var j = 0; j < codeLength; j++) {
                    generatedCode += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                codici.push(generatedCode);
            }
            codici.join(' , ')
            document.getElementById("code").value = codici;
            const prezzoTotLabel = document.getElementById('prezzoTotale');
            const durata = document.getElementById('durata').value;
            if(durata == 'esame'){
                prezzoTotLabel.innerText = "Il prezzo totale è di " + totCodes * 100 + "€";
            }else{
                const prezzoOra =Number(prezzoTotLabel.dataset.prezzo);
                prezzoTotLabel.innerText = "Il prezzo totale è di " + totCodes * (prezzoOra * (Number(durata)/60)) + "€";
            }
        });

        document.getElementById('createCodeForm').addEventListener('submit', function(event) {
            var codeInput = document.getElementById('code');
            if (codeInput.value.trim() === '') {
                event.preventDefault();
                alert('Il campo del codice è obbligatorio.');
            }
        });
    </script>
    <div class="tableContainer">
    <table>
        <thead>
            <tr>
                <th>N.</th>
                <th>Allievo</th>
                <th>Email</th>
                <th>Cellulare</th>
                <th>Esami pagati</th>
                <th>Guide</th>
                <th>Limitazioni</th>
                <th>Boccia</th>
                <th>Fatture</th>
            </tr>
        </thead>
        <tbody>

            
                <% for (let i = 0; i < utenti.length; i++) { %>
                    <tr class="allievi" data-archiviato="<%= utenti[i].archiviato %>">
                        <% let nomeAllievo = utenti[i].billingInfo[0].cognome + ' ' + utenti[i].billingInfo[0].nome %>
                        <% let codice = utenti[i].codicePagamento.length + '/' + (!utenti[i].totalCodes ? 0 : utenti[i].totalCodes)  %>
                        <td data-label="N"><span><%= i+1 %></span></td>
                        <td data-label="Allievo"><a class="nameModal" data-nomeallievo="<%= nomeAllievo %>" data-email="<%= utenti[i].email %>" data-codici="<%= JSON.stringify(utenti[i].codicePagamento) %>" data-codes="<%= codice %>" href=""><span><%= nomeAllievo %></span></a></td>
                        <td data-label="Email" data-email="<%= utenti[i].email %>"><span><%= utenti[i].email %></span></td>
                        <td data-label="Cellulare"><span><%= utenti[i].cell %></span></td>
                            <td data-label="Esami pagati"> 
                                <span>
                                    <% let totEsami = utenti[i].exams.length; %>
                                    <% if (utenti[i].exams[totEsami-1] == true) { %>
                                        <%= totEsami %>
                                    <% }else{%>
                                        <%= totEsami - 1 %>
                                    <% } %>
                                </span>
                            </td>
                            <% let collegamento = '/admin/fatture/:'+ utenti[i].userName; %>
                            <td data-label="Guide"> <button class="tableBtn"><a href=" <%=`/admin/guideSvolte/:${utenti[i].userName}` %>" >Ore lezioni</a></button></td>
                            <td data-label="Limitazioni"> <button class="limitation tableBtn" data-student="<%= utenti[i].userName %>" data-exclude="<%= JSON.stringify(utenti[i].exclude.map(exclude => exclude.instructor)) %>">limita istruttori</button></td>
                            <td data-label="Boccia"> <button class="boccia tableBtn" data-student="<%= utenti[i].userName %>" data-esame="<%= JSON.stringify(utenti[i].exams) %>">Boccia</button></td>
                            <% let noFatture = true %>
                            <% for( let j = 0; j < utenti[i].fatturaDaFare.length; j++ ) { %>
                                <% if (!utenti[i].fatturaDaFare[j].emessa) { %>
                                    <td data-label="Fatture"> <a href=" <%= collegamento %> "><button class="fatture tableBtn" style="background-color: orange !important;" data-student="<%= utenti[i].userName %>">Fatture</button></a></td>
                                    <% noFatture = false %>
                                    <% break; %>
                                <% } %>
                            <% } %>
                            <% if (noFatture) { %>
                                <td data-label="Fatture"> <a href=" <%= collegamento %> "><button class="fatture tableBtn" data-student="<%= utenti[i].userName %>">Fatture</button></a></td>
                            <% } %>
                        </tr>
                <% } %>
        </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('tbody tr.allievi').each(function() {
        var archived = $(this).data('archiviato');
        if (archived) {
            $(this).hide();
        }
    });
    $('#searchName, #searchPhone, #searchEmail, #searchExams, #searchArchived').on('input', function() {
        var nameFilter = $('#searchName').val().toLowerCase();
        var phoneFilter = $('#searchPhone').val().toLowerCase();
        var emailFilter = $('#searchEmail').val().toLowerCase();
        var examsFilter = parseInt($('#searchExams').val());
        var archivedFilter = $('#searchArchived').is(':checked');

        $('tbody tr.allievi').each(function() {
            var name = $(this).find('td:nth-child(2)').text().toLowerCase();
            var phone = $(this).find('td:nth-child(4)').text().toLowerCase();
            var email = $(this).find('td:nth-child(3)').text().toLowerCase();
            var exams = parseInt($(this).find('td:nth-child(5)').text());
            var archived = $(this).data('archiviato');

            var nameMatch = name.includes(nameFilter);
            var phoneMatch = phone.includes(phoneFilter);
            var emailMatch = email.includes(emailFilter);
            var examsMatch = isNaN(examsFilter) || exams === examsFilter;

            if (nameMatch && phoneMatch && emailMatch && examsMatch && (archivedFilter == archived)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});


</script>

<script>
document.getElementById('copiaEmail').addEventListener('click', function() {
    var visibleEmailRows = document.querySelectorAll('tr:not([style*="display:none"])');

    var visibleEmails = [];

    visibleEmailRows.forEach(function(row) {
        var td = row.querySelector('td[data-label="Email"]');
        if (td && (td.offsetWidth > 0 || td.offsetHeight > 0)) {
            visibleEmails.push(td.dataset.email);
        }
    });

    var emailsString = visibleEmails.join(', ');

    navigator.clipboard.writeText(emailsString).then(function() {
        alert('Indirizzi email visibili copiati negli appunti: ' + emailsString);
    }).catch(function(err) {
        console.error('Errore durante la copia negli appunti:', err);
    });
});

</script>


    </div>
    <div class="containerModal">
    <div class="actionsModal">
        <a href=" " class="close">
            <span class="material-symbols-outlined">
                cancel
            </span>
        </a>
        <table class="panoramicaCodiciTable">
            <thead>
                <tr>
                    <th id="codiciTh">Codici</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="Codici" id="codiciRimanenti"></td>
                </tr>
            </tbody>
        </table>
        <table>
            <thead>
                <tr>
                    <th>Codice</th>
                    <th>Data</th>
                    <th>Importo</th>
                </tr>
            </thead>
            <tbody class="codiciBody">

            </tbody>
        </table>
        <table class="archiviaTable">
            <thead>
                <tr>
                    <th>Archivia</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="Archivia" >
                        <a href="" id="archivia">
                            <span class="material-symbols-outlined">
                                archive
                            </span>
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
    <script>
        const nameModal = document.querySelectorAll('.nameModal');
        const codiciRimanentiLabel = document.getElementById('codiciRimanenti');
        const codiciTh = document.getElementById('codiciTh');
        const containerModal = document.querySelector('.containerModal');
        const archivia = document.getElementById('archivia');
        const codiciBody = document.querySelector('.codiciBody');
        nameModal.forEach((name)=>{
            name.addEventListener('click', (event) =>{
                event.preventDefault();
                codiciBody.innerHTML = '';
                containerModal.style.display = 'block';
                const codes = name.dataset.codes;
                const nome = name.dataset.nomeallievo;
                const email = name.dataset.email;
                const codici = JSON.parse(name.dataset.codici);
                codici.forEach(codice => {
                    const row = document.createElement('tr');
                    
                    const codiceCell = document.createElement('td');
                    codiceCell.setAttribute('data-label', 'Codice');
                    codiceCell.textContent = codice.codice;
                    row.appendChild(codiceCell);
                    
                    const dataCell = document.createElement('td');
                    dataCell.setAttribute('data-label', 'Data');
                    dataCell.textContent = codice.data;
                    row.appendChild(dataCell);

                    const importoCell = document.createElement('td');
                    importoCell.setAttribute('data-label', 'Importo');
                    importoCell.textContent = (codice.importo).toFixed(2) + '€';
                    row.appendChild(importoCell);
                    
                    codiciBody.appendChild(row);
                });
                codiciRimanentiLabel.dataset.label = 'Codici di ' + nome;
                codiciTh.innerText = 'Codici di ' + nome;
                codiciRimanentiLabel.innerText = (codes == '0/0' ? 'Nessun Codice Attivo' : codes);
                archivia.dataset.email = email;
                
            });
        });
        archivia.addEventListener('click', function(event) {
            event.preventDefault();
            if(confirm(`Sei sicuro di voler archiviare questo allievo?`)){
                const email = archivia.dataset.email;
                fetch('/ArchiviaUtente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({email: email})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Errore durante la richiesta POST');
                    }

                    return response.json();
                })
                .then(data => {
                    alert(data);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Si è verificato un errore:', error);
                });
            }
        });


    </script>

        <div id="formContainer" style="display: none;">
            <a href=" ">
                <span class="material-symbols-outlined">
                    cancel
                </span>
            </a>
            <div class="limitationButtons">
                <button id="activateExcludeForm">Aggiungi limitazioni</button>
                <button id="activateIncludeForm">Rimuovi limitazioni</button>
            </div>
            <form action="/excludeInstructor" id="excludeForm" class="form" method="POST" style="display: none;">
                <h2>Istruttori esclusi</h2>
                <input type="hidden" name="student" class="studentInput" id="excludeStudentInput" value="">
                <% for( let i = 0; i < istruttori.length; i++ ) { %>
                    <div class="instructorInput">
                        <label for="<%= istruttori[i].nome %> <%= istruttori[i].cognome %>"><%= istruttori[i] %> <%= istruttori[i].cognome %></label>
                        <input type="checkbox" class="instructorCheckBox" name="istruttori" value="<%= istruttori[i] %>">
                    </div>
                <% } %>
                <button type="submit">Conferma</button>
            </form>
            <form action="/includeInstructor" id="includeForm" class="form" method="POST" style="display: none;">
                <h2>Istruttori inclusi</h2>
                <input type="hidden" name="student" class="studentInput" id="includeStudentInput" value="">
                <% for( let i = 0; i < istruttori.length; i++ ) { %>
                    <div class="instructorInput">
                        <label for="<%= istruttori[i].nome %> <%= istruttori[i].cognome %>"><%= istruttori[i] %> <%= istruttori[i].cognome %></label>
                        <input type="checkbox" class="instructorCheckBox" name="istruttori" value="<%= istruttori[i] %>">
                    </div>
                <% } %>
                <button type="submit">Conferma</button>
            </form>
        </div>
        <script>
            const istruttori = Array('<%= istruttori %>');
            const limitationBtn = document.querySelectorAll('.limitation');
            const container = document.getElementById('formContainer');
            const excludeStudentInput = document.getElementById('excludeStudentInput');
            const includeStudentInput = document.getElementById('includeStudentInput');
            const excludeForm = document.getElementById('excludeForm');
            const includeForm = document.getElementById('includeForm');
            const activateExcludeForm = document.getElementById('activateExcludeForm');    
            const activateIncludeForm = document.getElementById('activateIncludeForm');
            const instructorCheckBox = document.querySelectorAll('.instructorCheckBox');
            let excludedInstructors;
            limitationBtn.forEach(btn => {
                btn.addEventListener('click', () =>{
                    let student = btn.dataset.student;
                    excludedInstructors = JSON.parse(btn.dataset.exclude);
                    includeStudentInput.value = student;
                    excludeStudentInput.value = student;
                    container.style.display = "flex";
                    // Preseleziona i checkbox degli istruttori esclusi
                    
                });
            });

            activateExcludeForm.addEventListener('click', () =>{
                excludeForm.style.display = 'flex';
                includeForm.style.display = 'none';
                instructorCheckBox.forEach(checkbox => {
                    const instructorName = checkbox.value;
                    var label = checkbox.parentNode;
                    if (excludedInstructors.includes(instructorName)) {
                        label.style.color = 'red';
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    } else {
                        label.style.color = 'green';
                        checkbox.checked = false;
                        checkbox.disabled = false;
                    }
                }); 
            });
            activateIncludeForm.addEventListener('click', () =>{
                includeForm.style.display = 'flex';
                excludeForm.style.display = 'none';
                instructorCheckBox.forEach(checkbox => {
                    const instructorName = checkbox.value;
                    var label = checkbox.parentNode;
                    if (excludedInstructors.includes(instructorName)) {
                        label.style.color = 'red';
                        checkbox.checked = false;
                        checkbox.disabled = false;
                    } else {
                        label.style.color = 'green';
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    }
                }); 
            });


            document.querySelectorAll('.boccia').forEach(button => {
    button.addEventListener('click', () => {
        const dataEsame = button.dataset.esame;
        const esami = JSON.parse(dataEsame);
        let posizioneBocciato;

        for (let i = 0; i < esami.length; i++) {
            const esame = esami[i];
            if (esame.paid && !esame.bocciato) {
                posizioneBocciato = i;
                break;
            }
        }
        const studente = button.dataset.student;
        if (confirm(`Sei sicuro di voler bocciare ${studente}?`)) {
            fetch('/boccia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ studente, posizioneBocciato })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta');
                }
                return response.json();
            })
            .then(data => {
                alert(data);
                window.location.reload();
            })
            .catch(error => {
                console.error('Si è verificato un errore:', error);
            });
        }
        
    });
});


        </script>




</body>
</html>